name: Push Config to Router via MCP

on:
  push:
    paths:
      - 'configs/*.cfg'

jobs:
  push-router-config:
    runs-on: ubuntu-latest

    env:
      MCP_URL: http://198.11.21.101:8000

    steps:
      - name: Checkout config repo
        uses: actions/checkout@v3

      - name: Extract changed router name
        id: router
        run: |
          FILE=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep .cfg | head -n1)
          echo "Changed file: $FILE"
          DEVICE=$(basename $FILE _ospf.cfg)
          echo "device=${DEVICE}" >> $GITHUB_OUTPUT
          echo "config_file=${FILE}" >> $GITHUB_OUTPUT

      - name: Push config via MCP
        run: |
          curl -X POST $MCP_URL/push/config \
          -H "Content-Type: application/json" \
          -d '{
            "device": "${{ steps.router.outputs.device }}",
            "config_file": "configs/${{ steps.router.outputs.config_file }}"
          }'

      - name: Notify on Slack
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
          -H 'Content-type: application/json' \
          --data '{"text":"âœ… Config applied via MCP to router ${{ steps.router.outputs.device }}"}'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
